(()=>{console.log("Background script running...");let e=null,t=[],s=[];chrome.storage.local.get(["connectedSites"],(e=>{s=e.connectedSites||[]})),chrome.runtime.onMessage.addListener(((c,a,n)=>{switch(console.log("Message received:",c),c.action){case"check_extension":return n({status:"installed"}),!0;case"connect_wallet":return chrome.storage.local.get(["password"],(function(e){const t=e;console.log("Result:",t)})),!0;case"lock_wallet":return chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t.length>0?(e=t[0].id,chrome.tabs.remove(e),n({success:!0})):n({success:!1})})),!0;case"unlock_wallet":null!==e&&chrome.tabs.create({url:chrome.runtime.getURL("profile.html"),active:!0},(t=>{e=t.id,console.log("Tab opened:",t)}));break;case"request_connection":const o={tabId:a.tab.id,url:a.tab.url,responseCallback:n};return t.push(o),chrome.runtime.sendMessage({action:"show_connection_request",request:o}),!0;case"approve_connection":const r=t.find((e=>e.tabId===c.requestId));r&&(s.push(r.url),chrome.storage.local.set({connectedSites:s}),chrome.tabs.sendMessage(r.tabId,{action:"connection_approved"}),t=t.filter((e=>e.tabId!==c.requestId)),r.responseCallback({success:!0}));break;case"reject_connection":const l=t.find((e=>e.tabId===c.requestId));l&&(chrome.tabs.sendMessage(l.tabId,{action:"connection_rejected"}),t=t.filter((e=>e.tabId!==c.requestId)),l.responseCallback({success:!1}));break;case"get_connected_sites":return n({sites:s}),!0;case"request_transaction":const i={tabId:a.tab.id,details:c.details,responseCallback:n};return t.push(i),chrome.runtime.sendMessage({action:"show_transaction_request",transactionRequest:i}),!0;case"approve_transaction":const d=t.find((e=>e.tabId===c.requestId));d&&(chrome.tabs.sendMessage(d.tabId,{action:"transaction_approved",details:d.details}),t=t.filter((e=>e.tabId!==c.requestId)),d.responseCallback({success:!0}));break;case"reject_transaction":const u=t.find((e=>e.tabId===c.requestId));u&&(chrome.tabs.sendMessage(u.tabId,{action:"transaction_rejected"}),t=t.filter((e=>e.tabId!==c.requestId)),u.responseCallback({success:!1}))}})),chrome.runtime.onInstalled.addListener((t=>{console.log("Extension installed:",t),"install"===t.reason&&chrome.tabs.create({url:chrome.runtime.getURL("welcome.html"),active:!0},(t=>{e=t.id,console.log("New tab created:",t)}))}))})();