(()=>{function e(){const e=prompt("Enter a password to lock the wallet:");e&&(localStorage.setItem("locked","true"),localStorage.setItem("password",e),chrome.runtime.sendMessage({action:"lock_wallet"},(e=>{e&&e.success?t():alert("Failed to lock wallet")})))}function t(){document.body.innerHTML='\n        <h1>Wallet Locked</h1>\n        <p>Your wallet is currently locked. Please enter your password to unlock it.</p>\n        <input type="password" id="unlock-password" placeholder="Enter your password" />\n        <button id="unlock-wallet-btn">Unlock Wallet</button>\n    ',document.getElementById("unlock-wallet-btn").addEventListener("click",n)}function n(){document.getElementById("unlock-password").value===localStorage.getItem("password")?(localStorage.removeItem("locked"),window.location.reload(),chrome.runtime.sendMessage({action:"unlock_wallet"})):alert("Incorrect password. Please try again.")}async function o(){const e=JSON.parse(localStorage.getItem("walletData")).mnemonic,t=document.getElementById("recipient-address").value,n=document.getElementById("send-amount").value;if(e&&t&&n)try{const o=await fetch("http://13.233.172.115:3000/send-funds",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mnemonic:e,recipientAddress:t,amount:n})}),c=await o.json();c.error?alert("Error: "+c.error):(document.getElementById("send-status").textContent=c.message,await a(JSON.parse(localStorage.getItem("walletData")).address))}catch(e){alert("Failed to send funds"),console.error("Error:",e)}else alert("Please fill in all fields")}async function a(e){try{const t=await fetch(`http://13.233.172.115:3000/check-balance/${e}`),n=await t.json();if(n.error)console.error("Error fetching balance:",n.error);else{let e=n.balance;e.startsWith("AED")||(e=`AED ${e}`),document.getElementById("balance").textContent=e}}catch(e){console.error("Failed to fetch balance",e)}}window.onload=async function(){if(localStorage.getItem("locked"))return void t();const n=localStorage.getItem("username"),c=JSON.parse(localStorage.getItem("walletData"));c?(document.getElementById("username").textContent=n,document.getElementById("address").textContent=c.address,await a(c.address),document.getElementById("send-funds-btn").addEventListener("click",o),document.getElementById("lock-wallet-btn").addEventListener("click",e),setInterval((async()=>{await a(c.address)}),5e3),chrome.runtime.onMessage.addListener((e=>{var t,n;"show_connection_request"===e.action?(n=e.request,document.body.innerHTML=`\n        <h1>Connection Request</h1>\n        <p>${n.url} wants to connect to your wallet.</p>\n        <button id="approve-connection">Approve</button>\n        <button id="reject-connection">Reject</button>\n    `,document.getElementById("approve-connection").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"approve_connection",requestId:n.tabId}),window.location.reload()})),document.getElementById("reject-connection").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"reject_connection",requestId:n.tabId}),window.location.reload()}))):"show_transaction_request"===e.action&&(t=e.transaction,document.body.innerHTML=`\n        <h1>Transaction Request</h1>\n        <p>Do you want to approve this transaction?</p>\n        <pre>${JSON.stringify(t,null,2)}</pre>\n        <button id="approve-transaction">Approve</button>\n        <button id="reject-transaction">Reject</button>\n    `,document.getElementById("approve-transaction").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"approve_transaction",transactionId:t.id}),window.location.reload()})),document.getElementById("reject-transaction").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"reject_transaction",transactionId:t.id}),window.location.reload()})))}))):document.body.innerHTML="<p>Please create or import a wallet first.</p>"},document.addEventListener("DOMContentLoaded",(function(){chrome.runtime.onMessage.addListener((function(e,t,n){if("request_connection"===e.action)return new Promise(((e,t)=>{e({address:walletData.address,balance:walletData.balance})})).then((e=>{chrome.storage.local.set({walletData:e},(function(){console.log("Wallet data saved:",e),n(e)}))})).catch((e=>{console.error("Failed to connect wallet:",e),n({success:!1,message:"Failed to connect wallet"})})),!0}))}))})();